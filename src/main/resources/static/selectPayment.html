<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <!-- SDK ì¶”ê°€ -->
  <script src="https://js.tosspayments.com/v2/standard"></script>
  <script defer src="/js/authStatus.js"></script>
  <script defer src="/js/payment.js"></script>
</head>
<body>

<!--ë°°ì†¡ì§€ ì…ë ¥-->
<div class="address-container border p-4 rounded w-80 mx-auto mt-4">
  <h2 class="text-lg font-semibold mb-3 text-center">ë°°ì†¡ì§€ ì…ë ¥</h2>

  <label for="address" class="block mb-1 text-sm font-medium">ì£¼ì†Œ</label>
  <input
          type="text"
          id="address"
          name="address"
          class="w-full border rounded p-1.5 mb-2 text-sm"
          placeholder="ì£¼ì†Œ"
          required
  >

  <label for="phone" class="block mb-1 text-sm font-medium">ì „í™”ë²ˆí˜¸</label>
  <input
          type="tel"
          id="phone"
          name="phone"
          class="w-full border rounded p-1.5 mb-2 text-sm"
          placeholder="01012345678"
          required
  >
</div>
<br>
<!-- ê²°ì œ ë²„íŠ¼ -->
<div class="text-center">
  <button class="button" style="margin-top: 30px" onclick="requestPayment()">ê²°ì œí•˜ê¸°</button>
</div>
<script>
  window.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("token");

    if (!token) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.");
      window.location.href = "/login.html";
      return;
    }

    // âœ… payment.jsì˜ getProfile() í˜¸ì¶œí•´ì„œ authUser ì„¸íŒ…
    const user = await getProfile();
    console.log(user);
    if (!user.email || !user.nickName) {
      alert("í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
      window.location.href = "/login.html";
      return;
    }

    // ------  SDK ì´ˆê¸°í™” ------
    // @docs https://docs.tosspayments.com/sdk/v2/js#í† ìŠ¤í˜ì´ë¨¼ì¸ -ì´ˆê¸°í™”
    const clientKey = "test_ck_yL0qZ4G1VOPgok2RnamvroWb2MQY";
    const customerKey = "SE_uUi3MjM-RH1jzca-9e";
    const tossPayments = TossPayments(clientKey);
    // íšŒì› ê²°ì œ
    // @docs https://docs.tosspayments.com/sdk/v2/js#tosspaymentspayment
    const payment = tossPayments.payment({ customerKey });
    // ë¹„íšŒì› ê²°ì œ
    // const payment = tossPayments.payment({customerKey: TossPayments.ANONYMOUS})
    // ------ 'ê²°ì œí•˜ê¸°' ë²„íŠ¼ ëˆ„ë¥´ë©´ ê²°ì œì°½ ë„ìš°ê¸° ------
    // @docs https://docs.tosspayments.com/sdk/v2/js#paymentrequestpayment

    // ì „ì—­ì— ë“±ë¡
    window.requestPayment = async function() {
      const orderName = sessionStorage.getItem("product_name");
      const total = Number(sessionStorage.getItem("total"));

      await payment.requestPayment({
        method: "CARD", // ì¹´ë“œ ê²°ì œ
        amount: {
          currency: "KRW",
          value: total
        },
        orderId: "ORDER_" + new Date().getTime(), // ê³ ìœ  ì£¼ë¬¸ë²ˆí˜¸
        orderName: orderName,
        successUrl: window.location.origin + "/success", // ê²°ì œ ìš”ì²­ì´ ì„±ê³µí•˜ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ëŠ” URL
        failUrl: window.location.origin + "/fail", // ê²°ì œ ìš”ì²­ì´ ì‹¤íŒ¨í•˜ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ëŠ” URL
        customerEmail: user.email,
        customerName: user.nickName,
        customerMobilePhone: document.getElementById("phone").value,
        // ì¹´ë“œ ê²°ì œì— í•„ìš”í•œ ì •ë³´
        card: {
          useEscrow: false,
          flowMode: "DEFAULT", // í†µí•©ê²°ì œì°½ ì—¬ëŠ” ì˜µì…˜
          useCardPoint: false,
          useAppCardOnly: false,
        },
      });

      console.log("ğŸ’¡ ê²°ì œ ìš”ì²­ ì „ ë°ì´í„° í™•ì¸");
      console.log("orderName:", orderName);
      console.log("total:", total);
      console.log("orderId:", orderId);

    };
  });
</script>
</body>
</html>
